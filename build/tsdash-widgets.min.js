/*! tsdash */

function WidgetSwimLanes(a){var b=this,c={start:null,end:null,events:null,target_div:"#divTarget",type_field:"type",side_margin:0,left_padding:30,circle_color:"#007ACC",circle_color_cb:null,circle_color2:null,circle_color2_cb:null,lanes_color:"#303030",lane_color:"#000000",lane_color2:"#111",lane_opacity:1,lane_selected_opacity:1,lane_height:30,circle_radius:8,circle_over_radius:10,ticks:10,click_cb:function(){},title_cb:function(a){return b.getTimeString(a.ts)}};if("undefined"!==a)for(var d in a)c[d]=a[d];c.circle_color=c.circle_color_cb||c.circle_color,c.circle_color2=c.circle_color2_cb||c.circle_color2||c.circle_color,c.target_div.startsWith("#")||(c.target_div="#"+c.target_div),this._p=c,this._sort_type="d",this.clear()}WidgetSwimLanes.prototype.clear=function(a){this._eventTypes=[],this._eventTypesDict={},this.analyzeEventTypes()},WidgetSwimLanes.prototype.redraw=function(a){this.clear(),this.draw()},WidgetSwimLanes.prototype.getTimeString=function(a){return a||(a=new Date),moment(a).format("YYYY-MM-DD hh:mm:ss")},WidgetSwimLanes.prototype.getEventType=function(a){return a[this._p.type_field]},WidgetSwimLanes.prototype.analyzeEventTypes=function(){for(var a=this,b=(this._p,this._p.events),c=this._eventTypes,d=this._eventTypesDict,e=0;e<b.length;e++){var f=b[e],g=this.getEventType(f);if(g in d){var h=d[g];c[h].max=f.ts,c[h].cnt++}else d[g]=c.length,c.push({type:g,min:f.ts,max:f.ts,cnt:1})}c.sort(function(b,c){return"d"==a._sort_type?b.min<c.min?-1:1:"c"==a._sort_type?b.cnt<c.cnt?1:-1:b.type.localeCompare(c.type)});for(var e=0;e<c.length;e++)d[c[e].type]=e},WidgetSwimLanes.prototype.draw=function(){var a=this,b=this._p,c=$(b.target_div).width(),d=b.events,e=b.start||d[0].ts,f=b.end||d[d.length-1].ts,g=f-e;e-=.05*g,f+=.05*g,$(b.target_div).empty().css("padding",b.side_margin).css("font-size",10).css("background-color",b.lanes_color);var h=[2*b.side_margin+b.left_padding,c-2*b.side_margin],i=d3.scale.linear().domain([e,f]).range(h),j=this._eventTypes,k=this._eventTypesDict,l=d3.select(b.target_div).append("svg").attr("width",c).attr("height",b.lane_height*j.length+40),m=d3.time.scale().domain([new Date(e),new Date(f)]).range(h);l.append("g").attr("transform","translate(0,20)").attr("class","axis").call(d3.svg.axis().scale(m).orient("top").ticks(b.ticks).innerTickSize(5).outerTickSize(1)).style("fill",b.circle_color).style("stroke","none");var n=l.append("g").selectAll(".timeline-lane").data(j).enter().append("g").attr("transform",function(a,c){return"translate(0,"+(20+c*b.lane_height)+")"}),o=0;n.append("rect").attr("class","timeline-lane").attr("x",0).attr("y",0).attr("width",c).attr("height",b.lane_height).attr("fill",function(){return o++%2==0?b.lane_color:b.lane_color2}).on("click",function(a,b){}),n.append("text").attr("class","timeline-lane-title").attr("x",5).attr("dy","1.5em").text(function(a,b){return a.type||""}),l.selectAll("circle").data(d).enter().append("circle").attr("cy",function(c){return 20+(.5+k[a.getEventType(c)])*b.lane_height}).attr("cx",function(a){return i(a.ts)}).attr("r",b.circle_radius_cb||b.circle_radius).attr("fill",b.circle_color).attr("fill-opacity",b.circle_opacity_cb||1).on("click",b.click_cb).on("mouseover",function(a){d3.select(this).transition().duration(50).attr("r",b.circle_over_radius).attr("fill",b.circle_color2)}).on("mouseout",function(a){d3.select(this).transition().duration(50).attr("r",b.circle_radius).attr("fill",b.circle_color)}).append("svg:title").text(b.title_cb),m=d3.time.scale().domain([new Date(e),new Date(f)]).range(h),l.append("g").attr("transform","translate(0,"+(20+b.lane_height*j.length)+")").attr("class","axis").call(d3.svg.axis().scale(m).orient("bottom").ticks(b.ticks).innerTickSize(5).outerTickSize(1)).style("fill",b.circle_color).style("stroke","none");var p=l.append("text").attr("x",5).attr("y",12).text("Type /");p.on("click",function(){a._sort_type="t",a.redraw()}),p.style("cursor","pointer");var q=l.append("text").attr("x",32).attr("y",12).text("Date /");q.on("click",function(){a._sort_type="d",a.redraw()}),q.style("cursor","pointer");var r=l.append("text").attr("x",62).attr("y",12).text("Count");r.on("click",function(){a._sort_type="c",a.redraw()}),r.style("cursor","pointer")};