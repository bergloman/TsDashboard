/*! tsdash 2016-08-10 */
function TsDashboard(a,b){this.driver=b,this.div_id=a,this.init(),this.regex_date=/^(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))$/,this.regex_datetime=/^(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31)) (0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9]){2}$/}TsDashboard.prototype.init=function(){var a=this;a.driver.getViewDefinition(function(b){a.conf=b,a.conf.parameters=a.conf.parameters||[],a.top=$("#"+a.div_id),a.top.append("<div class='tsd-header'></div>"),a.top.append("<div class='tsd-sidebar dark-matter'></div>"),a.top.append("<div class='tsd-main' id='tsd_main'></div>"),$(".tsd-header").append("<h1>"+b.title+"</h1>"),$(".tsd-main").append("<div role='alert'' class='tsd-error alert alert-danger'>...</div>"),$(".tsd-main").append("<div class='tsd-main-content' id='tsd_main_content'></div>"),$(".tsd-main").append("<div class='modal' id='divModal' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' aria-hidden='true'>                <div class='modal-dialog'>                    <div class='modal-content'>                        <div class='modal-header'>                            <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>                            <h4 class='modal-title' id='myModalLabel'>                            <span data-bind='text: modal_title'></span>                            </h4>                        </div>                        <div class='modal-body'>                            <div id='divModalChart'></div>                        </div>                        <div class='modal-footer'>                            <button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>                        </div>                    </div>                </div>            </div>"),a.initParams()})},TsDashboard.prototype.resetErrorMsg=function(){$(".tsd-error").removeClass("tsd-error-visible")},TsDashboard.prototype.showErrorMsg=function(a){$(".tsd-error").text(a),$(".tsd-error").addClass("tsd-error-visible")},TsDashboard.prototype.getToday=function(){return moment({hour:0}).toDate()},TsDashboard.prototype.getTimeString=function(a){return a||(a=new Date),moment(a).format("YYYY-MM-DD hh:mm:ss")},TsDashboard.prototype.getDateString=function(a){return a||(a=new Date),moment(a).format("YYYY-MM-DD")},TsDashboard.prototype.initParams=function(){var a=this,b=$(".tsd-sidebar");for(var c in a.conf.parameters)(function(c){var d=a.conf.parameters[c],e=$(document.createElement("div"));e.appendTo(b),e.addClass("tsd-sidebar-param"),e.append("<span>"+d.title+"</span>"),"string"===d.type?(e.append("<input id='in"+d.name+"'></input>"),d.default&&$("#in"+d.name).val(d.default)):"datetime"===d.type?(e.append("<input id='in"+d.name+"' placeholder='yyyy-mm-dd hh:MM:ss'></input>"),$("#in"+d.name).blur(function(){var b=$("#in"+d.name).val();a.regex_date.test(b)&&$("#in"+d.name).val(b+" 00:00:00")}),e.append("<a id='hin_now_"+d.name+"' class='tsd-input-help'>Now</a> "),$("#hin_now_"+d.name).click(function(){$("#in"+d.name).val(a.getTimeString())}),e.append("<a id='hin_today_"+d.name+"' class='tsd-input-help'>Today</a> "),$("#hin_today_"+d.name).click(function(){$("#in"+d.name).val(a.getDateString()+" 00:00:00")}),d.default&&(d.default instanceof Date?$("#in"+d.name).val(a.getTimeString(d.default)):"$now"==d.default?$("#in"+d.name).val(a.getTimeString()):"$today"==d.default?$("#in"+d.name).val(a.getDateString()+" 00:00:00"):$("#in"+d.name).val(d.default))):"date"===d.type?(e.append("<input id='in"+d.name+"' placeholder='yyyy-mm-dd'></input>"),e.append("<a id='hin_today_"+d.name+"' class='tsd-input-help'>Today</a> "),$("#hin_today_"+d.name).click(function(){$("#in"+d.name).val(a.getDateString())}),d.default&&(d.default instanceof Date?$("#in"+d.name).val(a.getDateString(d.default)):"$now"==d.default?$("#in"+d.name).val(a.getDateString()):"$today"==d.default?$("#in"+d.name).val(a.getDateString()):$("#in"+d.name).val(d.default))):"filter"===d.type?(e.append("<input id='in"+d.name+"'></input>"),e.append("<div id='opt"+d.name+"' class='tsd-match-options'></div>"),$("#in"+d.name).keyup(function(){var b=$("#in"+d.name).val();b.length<3||a.driver.getParamValues(d.name,b,function(a){$("#opt"+d.name).empty(),$("#opt"+d.name).show();for(var b in a)(function(b){var c=$(document.createElement("div"));c.text(a[b]),c.click(function(){$("#in"+d.name).val(a[b]),$("#opt"+d.name).empty(),$("#opt"+d.name).hide()}),$("#opt"+d.name).append(c)})(b)})}),d.default&&$("#in"+d.name).val(d.default)):"enum"===d.type?(e.append("<select id='sel"+d.name+"'></select >"),a.driver.getParamValues(d.name,null,function(a){for(var b in a){var c=a[b];$("#sel"+d.name).append("<option value='"+c.value+"'>"+c.caption+"</option>")}d.default&&$("#sel"+d.name).val(d.default)})):"boolean"===d.type&&(e.append("<input type='checkbox' id='cb"+d.name+"'></input>"),d.default&&$("#cb"+d.name).attr("checked","true"))})(c);var d=$(document.createElement("button"));d.text("Run"),d.click(function(){a.run()}),d.appendTo(b)},TsDashboard.prototype.collectParameterValues=function(){var a=this,b=[];for(var c in a.conf.parameters){var d=a.conf.parameters[c],e={name:d.name};if("string"===d.type){if(e.value=$("#in"+d.name).val().trim(),!d.optional&&""===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null}else if("datetime"===d.type){if(e.value=$("#in"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null;if(!a.regex_datetime.test(e.value)){if(!a.regex_date.test(e.value))return a.showErrorMsg("Invalid date format or value: "+d.title),null;e.value+=" 00:00:00"}e.value=moment(e.value,"YYYY-MM-DD HH:mm:ss").toDate()}else if("date"===d.type){if(e.value=$("#in"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null;if(!a.regex_date.test(e.value))return a.showErrorMsg("Invalid date format or value: "+d.title),null;e.value=moment(e.value,"YYYY-MM-DD").toDate()}else if("filter"===d.type){if(e.value=$("#in"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null}else if("enum"===d.type){if(e.value=$("#sel"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null}else"boolean"===d.type&&(e.value=!1,$("#cb"+d.name).attr("checked")&&(e.value=!0));b.push(e)}return b},TsDashboard.prototype.run=function(){var a=this,b=$("#tsd_main_content");b.empty(),a.resetErrorMsg();var c=a.collectParameterValues();if(c){var d={conf:a.conf,params:c};a.driver.getDrawData(d,function(c){var d=1;for(var e in a.conf.blocks){var f=a.conf.blocks[e],g=$(document.createElement("div"));b.append(g),g.addClass("tsd-block"),f.title&&f.title.length>0&&g.append($(document.createElement("h2")).text(f.title));var h=$(document.createElement("div"));h.addClass("tsd-block-inner"),g.append(h);var i="tsd-col-1-"+f.panels.length;for(var j in f.panels){var k=f.panels[j],l=$(document.createElement("div"));h.append(l),l.addClass("tsd-panel"),l.addClass(i),k.title&&k.title.length>0&&l.append($(document.createElement("h3")).text(k.title));for(var m in k.widgets){var n=k.widgets[m],o=$(document.createElement("div"));l.append(o),o.addClass("tsd-widget"),n.title&&n.title.length>0&&o.append($(document.createElement("h3")).text(n.title));var p="tsd_widget_"+d;o.append($(document.createElement("div")).attr("id",p).attr("class","tsd-widget-sub"));var q=[];q=n.timeseries.map(function(a){for(var b in c.timeseries){var d=c.timeseries[b];if(d.name===a)return d.values}return null}).filter(function(a){return null!==a});var r={chart_div:"#"+p,data:q,height:n.height,handle_clicks:!0};r.click_callback=function(b){return function(){a.showModal(b)}}(r),n.options&&Object.assign(r,n.options),a.drawTimeSeriesMulti(r),d++}}}})}},TsDashboard.prototype.showModal=function(a){var b=this;$("#divModal").on("shown.bs.modal",function(c){a.chart_div="#divModalChart",a.height=800,a.handle_clicks=!0,a.click_callback=function(){},b.drawTimeSeriesMulti(a)}),$("#divModal").modal()},TsDashboard.prototype.toNiceDateTime=function(a){return a?moment(a).format("YYYY-MM-DD HH:mm:ss"):"-"},TsDashboard.prototype.drawTimeSeriesMulti=function(a){var b=this,c={chart_div:"#someChart",data:null,height:100,xaccessor:function(a){return a.epoch},yaccessor:function(a){return a.val},xdomain:null,xdomain_min:null,xdomain_max:null,ydomain:null,ydomain_min:null,ydomain_max:null,xcaption:null,ycaptions:null,series_style_indices:null,handle_clicks:!1,show_grid:!0,x_axis_label:null,y_axis_label:null,graph_css:"area",xAxisFontSize:"14px",yAxisFontSize:"14px",xAxisTicks:7,yFormatValue:"s",tickNumber:function(a,b){return Math.min(a<100?3:8,b)},markerStroke:1,markerOpacity:.4,markerOpacityHover:.6,markerColor:"#ff0000",click_callback:null,timepoints:null,timepoint_callback:null};if("undefined"!==a)for(var d in a)c[d]=a[d];if(!c.xdomain){var e=c.data.map(function(a){return d3.extent(a,c.xaccessor)}),f=[];e.forEach(function(a){f=f.concat(a)}),c.xdomain=d3.extent(f)}if(!c.ydomain){var e=c.data.map(function(a){return d3.extent(a,c.yaccessor)}),f=[];e.forEach(function(a){f=f.concat(a)}),c.ydomain=d3.extent(f)}null!==c.xdomain_min&&(c.xdomain[0]=c.xdomain_min),null!==c.xdomain_max&&(c.xdomain[1]=c.xdomain_max),null!==c.ydomain_min&&(c.ydomain[0]=c.ydomain_min),null!==c.ydomain_max&&(c.ydomain[1]=c.ydomain_max);var h=0;if(c.data.forEach(function(a){h+=a.length}),!c.series_style_indices){c.series_style_indices=[];for(var i=0;i<c.data.length;i++)c.series_style_indices.push(i)}$(c.chart_div).empty();var j={top:18,right:35,bottom:20,left:50};c.x_axis_label&&(j.bottom+=20);var k=$(c.chart_div).width()-j.left-j.right,l=c.height-j.top-j.bottom,m=(d3.time.format("%d-%b-%y").parse,d3.time.scale().domain(c.xdomain).range([0,k])),n=d3.scale.linear().domain(c.ydomain).range([l,0]),o=((m.domain()[1].getTime()-m.domain()[0].getTime())/1e3/60,d3.time.format.multi([[".%L",function(a){return a.getMilliseconds()}],[":%S",function(a){return a.getSeconds()}],["%I:%M",function(a){return a.getMinutes()}],["%I:%M",function(a){return a.getHours()}],["%d %b",function(a){return a.getDay()&&1!=a.getDate()}],["%d %b",function(a){return 1!=a.getDate()}],["%d %b",function(a){return a.getMonth()}],["%d %b %Y",function(){return!0}]])),p=d3.svg.axis().scale(m).orient("bottom").ticks(c.xAxisTicks).tickFormat(o);c.show_grid&&p.innerTickSize(-l).outerTickSize(0).tickPadding(10);var q=d3.format(c.yFormatValue),r=c.tickNumber(l,c.ydomain[1]),s=d3.svg.axis().scale(n).orient("left").ticks(r).tickFormat(function(a){return q(a)});c.show_grid&&s.innerTickSize(-k).outerTickSize(0).tickPadding(10);for(var t=d3.svg.line().x(function(a){return m(c.xaccessor(a))}).y(function(a){return n(c.yaccessor(a))}),u=d3.select(c.chart_div).append("svg").attr("width",k+j.left+j.right).attr("height",l+j.top+j.bottom).append("g").attr("transform","translate("+j.left+","+j.top+")"),i=0;i<c.data.length;i++){var v=c.data[i];u.append("path").attr("class","series series"+c.series_style_indices[i]).attr("d",t(v))}u.append("g").attr("class","x axis").attr("transform","translate(0, "+l+")").style("font-size",c.xAxisFontSize).call(p),g=u.append("g").attr("class","y axis").style("font-size",c.yAxisFontSize).call(s),null!=c.x_axis_label&&u.append("text").attr("class","x label").attr("text-anchor","end").attr("x",k-10).attr("y",l+j.top+16).text(c.x_axis_label),null!=c.y_axis_label&&u.append("text").attr("class","y label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)").text(c.y_axis_label);var w=d3.select(c.chart_div).append("div").attr("class","line-chart-tooltip").attr("id",c.chart_div+"_tooltip").style("opacity",0);if(c.handle_clicks){var x=function(a){var b=d3.mouse(a),d=m.invert(b[0]),e=d3.bisector(c.xaccessor).left,f=e(c.data[0],d),g=c.data[0][f-1],h=c.data[0][f];return 0==f&&(g=h),f>=c.data[0].length&&(h=g),d.getTime()-c.xaccessor(g)>c.xaccessor(h)-d.getTime()?h:g};g.on("click",function(){if(c.click_callback){var a=x(this);c.click_callback(a.epoch)}});var y=g.append("g").style("display","none");y.append("line").attr("id","focusLineX").attr("class","focusLine").style("stroke-dasharray","5, 3"),y.append("line").attr("id","focusLineY").attr("class","focusLine").style("stroke-dasharray","5, 3"),y.append("circle").attr("id","focusCircle").attr("r",5).attr("class","circle focusCircle"),g.append("rect").attr("class","overlay").attr("width",k).attr("height",l).on("mouseover",function(){y.style("display",null)}).on("mouseout",function(){y.style("display","none"),w.style("opacity",0)}).on("mousemove",function(){var a=x(this),d=m(new Date(c.xaccessor(a))),e=n(c.yaccessor(a));y.style("display",null),w.style("opacity",.8),w.html(c.yaccessor(a).toFixed(4)+"<br/>"+b.toNiceDateTime(c.xaccessor(a))).style("left",d-10+"px").style("top",e+40+"px"),y.select("#focusCircle").attr("cx",d).attr("cy",e),y.select("#focusLineX").attr("x1",d).attr("y1",n(n.domain()[0])).attr("x2",d).attr("y2",n(n.domain()[1])),y.select("#focusLineY").attr("x1",m(m.domain()[0])).attr("y1",e).attr("x2",m(m.domain()[1])).attr("y2",e)})}if(c.timepoints)for(var i=0;i<c.timepoints.length;i++){var z=c.timepoints[i].url,A=c.timepoints[i].title,B=new Date(c.timepoints[i].ts).getTime(),C=new Date(c.timepoints[i].ts).toString(),D=m(B),E=c.markerColor;!isNaN(D)&&D>0&&u.append("a").attr("xlink:href",z).append("line").attr("id",D).attr("data:ts",C).attr("data:tt-title",A).attr("x1",D).attr("x2",D).attr("y1",0).attr("y2",c.height-j.top-j.bottom).style("stroke",E).style("stroke-width",c.markerStroke).style("opacity",c.markerOpacity).on("mouseover",function(a){var b=d3.select(this)[0][0].id,d=d3.select(this)[0][0].attributes[1].value,e=d3.select(this)[0][0].attributes[2].value;d3.select(this).style("opacity",1),w.style("opacity",c.markerOpacityHover),w.html(e+"<br/>"+d).style("left",b-70+"px").style("bottom",l+"px")}).on("mouseout",function(a){d3.select(this).style("opacity",c.markerOpacity),w.style("opacity",0)})}h<=0&&g.append("text").attr("x",k/2).attr("y",l/2).attr("dy","1em").attr("text-anchor","end").text("NO DATA!").attr("class","zerolinetext")},Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null==this)throw new TypeError(" this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=0;d<f;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),Array.prototype.filter||(Array.prototype.filter=function(a){"use strict";if(void 0===this||null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments.length>=2?arguments[1]:void 0,f=0;f<c;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d});