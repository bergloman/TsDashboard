/*! tsdash 2016-08-26 */
function TsDashboard(a,b){this.driver=b,this.div_id=a,this.init(),this.regex_date=/^(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))$/,this.regex_datetime=/^(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31)) (0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9]){2}$/,this.driver.registerView&&this.driver.registerView(this)}TsDashboard.prototype.onParamChange=function(a){self.driver.onParamChange&&self.driver.onParamChange(a)},TsDashboard.prototype.init=function(){var a=this;a.driver.getViewDefinition(function(b){a.conf=b,a.conf.parameters=a.conf.parameters||[],a.top=$("#"+a.div_id),a.top.addClass("tsd"),a.conf.hide_sidebar?a.top.append("<div class='tsd-main' id='tsd_main'></div>"):(a.top.append("<div class='tsd-sidebar dark-matter'></div>"),a.top.append("<div class='tsd-main' id='tsd_main'></div>"),a.conf.sidebar_width=a.conf.sidebar_width||190,$(".tsd-sidebar").width(a.conf.sidebar_width),$(".tsd-main").css("margin-left",+a.conf.sidebar_width+"px"),$(".tsd-sidebar").append("<h1>"+b.title+"</h1>"),a.initParams()),$(".tsd-main").append("<div role='alert'' class='tsd-error alert alert-danger'>...</div>"),$(".tsd-main").append("<div class='tsd-main-content' id='tsd_main_content'></div>"),$(".tsd-main").append("<div class='modal' id='divModal' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' aria-hidden='true'>                <div class='modal-dialog'>                    <div class='modal-content'>                        <div class='modal-header'>                            <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>                            <h4 class='modal-title' id='myModalLabel'>                            <span data-bind='text: modal_title'></span>                            </h4>                        </div>                        <div class='modal-body'>                            <div id='divModalChart'></div>                        </div>                    </div>                </div>            </div>"),a.conf.hide_sidebar&&a.run()})},TsDashboard.prototype.getParamValue=function(a){return $("#in"+a).val()},TsDashboard.prototype.setParamValue=function(a,b){var c=this;for(var d in c.conf.parameters)(function(d){var e=c.conf.parameters[d];e.name==a&&("boolean"===e.type?(label.append("<input type='checkbox' id='cb"+e.name+"'></input>"),e.default&&$("#cb"+e.name).attr("checked","true")):$("#in"+e.name).val(b))})(d)},TsDashboard.prototype.resetErrorMsg=function(){$(".tsd-error").removeClass("tsd-error-visible")},TsDashboard.prototype.showErrorMsg=function(a){$(".tsd-error").text(a),$(".tsd-error").addClass("tsd-error-visible")},TsDashboard.prototype.getToday=function(){return moment({hour:0}).toDate()},TsDashboard.prototype.getTimeString=function(a){return a||(a=new Date),moment(a).format("YYYY-MM-DD hh:mm:ss")},TsDashboard.prototype.getDateString=function(a){return a||(a=new Date),moment(a).format("YYYY-MM-DD")},TsDashboard.prototype.initParams=function(){var a=this,b=$(".tsd-sidebar");for(var c in a.conf.parameters)(function(c){var d=a.conf.parameters[c],e=$(document.createElement("div"));e.appendTo(b),e.addClass("tsd-sidebar-param"),e.append("<span>"+d.title+"</span>"),"string"===d.type?(e.append("<input id='in"+d.name+"'></input>"),d.default&&$("#in"+d.name).val(d.default)):"datetime"===d.type?(e.append("<input id='in"+d.name+"' placeholder='yyyy-mm-dd hh:MM:ss'></input>"),$("#in"+d.name).blur(function(){var b=$("#in"+d.name).val();a.regex_date.test(b)&&$("#in"+d.name).val(b+" 00:00:00")}),e.append("<a id='hin_now_"+d.name+"' class='tsd-input-help'>Now</a> "),$("#hin_now_"+d.name).click(function(){$("#in"+d.name).val(a.getTimeString())}),e.append("<a id='hin_today_"+d.name+"' class='tsd-input-help'>Today</a> "),$("#hin_today_"+d.name).click(function(){$("#in"+d.name).val(a.getDateString()+" 00:00:00")}),d.default&&(d.default instanceof Date?$("#in"+d.name).val(a.getTimeString(d.default)):"$now"==d.default?$("#in"+d.name).val(a.getTimeString()):"$today"==d.default?$("#in"+d.name).val(a.getDateString()+" 00:00:00"):$("#in"+d.name).val(d.default))):"date"===d.type?(e.append("<input id='in"+d.name+"' placeholder='yyyy-mm-dd'></input>"),e.append("<a id='hin_today_"+d.name+"' class='tsd-input-help'>Today</a> "),$("#hin_today_"+d.name).click(function(){$("#in"+d.name).val(a.getDateString())}),d.default&&(d.default instanceof Date?$("#in"+d.name).val(a.getDateString(d.default)):"$now"==d.default?$("#in"+d.name).val(a.getDateString()):"$today"==d.default?$("#in"+d.name).val(a.getDateString()):$("#in"+d.name).val(d.default))):"filter"===d.type?(e.append("<input id='in"+d.name+"'></input>"),e.append("<div id='opt"+d.name+"' class='tsd-match-options'></div>"),$("#in"+d.name).keyup(function(){var b=$("#in"+d.name).val(),c=void 0===d.search_min_len&&b.length<3||void 0!==d.search_min_len&&b.length<d.search_min_len;c||a.driver.getParamValues(d.name,b,function(a){$("#opt"+d.name).empty(),$("#opt"+d.name).show();for(var b in a)(function(b){var c=$(document.createElement("div"));c.text(a[b]),c.click(function(){$("#in"+d.name).val(a[b]),$("#opt"+d.name).empty(),$("#opt"+d.name).hide()}),$("#opt"+d.name).append(c)})(b)})}),d.default&&$("#in"+d.name).val(d.default)):"enum"===d.type?(e.append("<select id='in"+d.name+"'></select >"),a.driver.getParamValues(d.name,null,function(a){for(var b in a){var c=a[b];$("#in"+d.name).append("<option value='"+c.value+"'>"+c.caption+"</option>")}d.default&&$("#in"+d.name).val(d.default)})):"boolean"===d.type&&(e.append("<input type='checkbox' id='in"+d.name+"'></input>"),d.default&&$("#in"+d.name).attr("checked","true")),$("#in"+d.name).change(function(){a.onParamChange(d.name)})})(c);var d=$(document.createElement("button"));d.text("Run"),d.click(function(){a.run()}),d.appendTo(b)},TsDashboard.prototype.collectParameterValues=function(){var a=this,b=[];for(var c in a.conf.parameters){var d=a.conf.parameters[c],e={name:d.name};if("string"===d.type){if(e.value=$("#in"+d.name).val().trim(),!d.optional&&""===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null}else if("datetime"===d.type){if(e.value=$("#in"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null;if(!a.regex_datetime.test(e.value)){if(!a.regex_date.test(e.value))return a.showErrorMsg("Invalid date format or value: "+d.title),null;e.value+=" 00:00:00"}e.value=moment(e.value,"YYYY-MM-DD HH:mm:ss").toDate()}else if("date"===d.type){if(e.value=$("#in"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null;if(!a.regex_date.test(e.value))return a.showErrorMsg("Invalid date format or value: "+d.title),null;e.value=moment(e.value,"YYYY-MM-DD").toDate()}else if("filter"===d.type){if(e.value=$("#in"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null}else if("enum"===d.type){if(e.value=$("#sel"+d.name).val(),!d.optional&&null===e.value)return a.showErrorMsg("Missing non-optional parameter: "+d.title),null}else"boolean"===d.type&&(e.value=!1,$("#cb"+d.name).attr("checked")&&(e.value=!0));b.push(e)}return b},TsDashboard.prototype.run=function(){var a=this,b=$("#tsd_main_content");b.empty(),a.resetErrorMsg();var c=a.collectParameterValues();if(c){var d={conf:a.conf,params:c};a.driver.getDrawData(d,function(c){var d=1;for(var e in a.conf.blocks){var f=a.conf.blocks[e],g=$(document.createElement("div"));b.append(g),g.addClass("tsd-block"),f.title&&f.title.length>0&&g.append($(document.createElement("h2")).text(f.title));var h=$(document.createElement("div"));h.addClass("tsd-block-inner"),g.append(h);var i="tsd-col-1-"+f.panels.length;for(var j in f.panels){var k=f.panels[j],l=$(document.createElement("div"));h.append(l),l.addClass("tsd-panel"),l.addClass(i),k.title&&k.title.length>0&&l.append($(document.createElement("h3")).text(k.title));for(var m in k.widgets){var n=k.widgets[m];n.type=n.type||"timeseries",n.timepoints=n.timepoints||[];var o=$(document.createElement("div"));l.append(o),o.addClass("tsd-widget"),n.title&&n.title.length>0&&o.append($(document.createElement("h3")).text(n.title));var p="tsd_widget_"+d;if(o.append($(document.createElement("div")).attr("id",p).attr("class","tsd-widget-sub")),"timeseries"==n.type){var q=[];q=n.timeseries.map(function(a){for(var b in c.timeseries){var d=c.timeseries[b];if(d.name===a)return d.values}return null}).filter(function(a){return null!==a});var r=[];r=n.timepoints.map(function(a){for(var b in c.timepoints){var d=c.timepoints[b];if(d.name===a)return d.values}return null}).filter(function(a){return null!==a});var s={chart_div:"#"+p,data:q,timepoints:r,xdomain:c.timeseries[0].xdomain,height:n.height,handle_clicks:!0};s.click_callback=function(b){return function(){a.showModal(b)}}(s),n.options&&Object.assign(s,n.options),a.drawTimeSeriesMulti(s)}else if("histogram"==n.type){var q=[];q=n.dataseries.map(function(a){for(var b in c.dataseries){var d=c.dataseries[b];if(d.name===a)return d.values}return null}).filter(function(a){return null!==a});var s={chart_div:"#"+p,data:q[0],xdomain:c.dataseries[0].xdomain,height:n.height,handle_clicks:!0};s.click_callback=function(b){return function(){a.showModalColumnChart(b)}}(s),n.options&&Object.assign(s,n.options),a.drawColumnChart(s)}d++}}}})}},TsDashboard.prototype.showModal=function(a){var b=this;$("#divModal").on("shown.bs.modal",function(c){a.chart_div="#divModalChart",a.height=800,a.handle_clicks=!0,a.click_callback=function(){},b.drawTimeSeriesMulti(a)}),$("#divModal").modal()},TsDashboard.prototype.showModalColumnChart=function(a){var b=this;$("#divModal").on("shown.bs.modal",function(c){a.chart_div="#divModalChart",a.height=500,a.handle_clicks=!1,a.click_callback=function(){},b.drawColumnChart(a)}),$("#divModal").modal()},TsDashboard.prototype.toNiceDateTime=function(a){return a?moment(a).format("YYYY-MM-DD HH:mm:ss"):"-"},TsDashboard.prototype.drawTimeSeriesMulti=function(a){var b=this,c={chart_div:"#someChart",data:null,height:100,xaccessor:function(a){return a.epoch},yaccessor:function(a){return a.val},xdomain:null,xdomain_min:null,xdomain_max:null,ydomain:null,ydomain_min:null,ydomain_max:null,xcaption:null,ycaptions:null,series_style_indices:null,handle_clicks:!1,show_grid:!0,x_axis_label:null,y_axis_label:null,graph_css:"area",xAxisFontSize:"14px",yAxisFontSize:"14px",xAxisTicks:7,yFormatValue:"s",tickNumber:function(a,b){return Math.min(a<100?3:8,b)},markerStroke:3,markerOpacity:.4,markerOpacityHover:.8,markerColor:"#ff0000",click_callback:null,timepoints:null,timepoint_callback:null};if("undefined"!==a)for(var d in a)c[d]=a[d];if(!c.xdomain){var e=c.data.map(function(a){return d3.extent(a,c.xaccessor)}),f=[];e.forEach(function(a){f=f.concat(a)}),c.xdomain=d3.extent(f)}if(!c.ydomain){var e=c.data.map(function(a){return d3.extent(a,c.yaccessor)}),f=[];e.forEach(function(a){f=f.concat(a)}),c.ydomain=d3.extent(f)}null!==c.xdomain_min&&(c.xdomain[0]=c.xdomain_min),null!==c.xdomain_max&&(c.xdomain[1]=c.xdomain_max),null!==c.ydomain_min&&(c.ydomain[0]=c.ydomain_min),null!==c.ydomain_max&&(c.ydomain[1]=c.ydomain_max);var h=0;if(c.data.forEach(function(a){h+=a.length}),!c.series_style_indices){c.series_style_indices=[];for(var i=0;i<c.data.length;i++)c.series_style_indices.push(i)}$(c.chart_div).empty();var j={top:18,right:35,bottom:20,left:50};c.x_axis_label&&(j.bottom+=20);var k=$(c.chart_div).width()-j.left-j.right,l=c.height-j.top-j.bottom,m=(d3.time.format("%d-%b-%y").parse,d3.time.scale().domain(c.xdomain).range([0,k])),n=d3.scale.linear().domain(c.ydomain).range([l,0]),o=((m.domain()[1].getTime()-m.domain()[0].getTime())/1e3/60,d3.time.format.multi([[".%L",function(a){return a.getMilliseconds()}],[":%S",function(a){return a.getSeconds()}],["%H:%M",function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%d %b",function(a){return a.getDay()&&1!=a.getDate()}],["%d %b",function(a){return 1!=a.getDate()}],["%d %b",function(a){return a.getMonth()}],["%d %b %Y",function(){return!0}]])),p=d3.svg.axis().scale(m).orient("bottom").ticks(c.xAxisTicks).tickFormat(o);c.show_grid&&p.innerTickSize(-l).outerTickSize(0).tickPadding(10);var q=d3.format(c.yFormatValue),r=c.tickNumber(l,c.ydomain[1]),s=d3.svg.axis().scale(n).orient("left").ticks(r).tickFormat(function(a){return q(a)});c.show_grid&&s.innerTickSize(-k).outerTickSize(0).tickPadding(10);for(var t=d3.svg.line().x(function(a){return m(c.xaccessor(a))}).y(function(a){return n(c.yaccessor(a))}),u=d3.select(c.chart_div).append("svg").attr("width",k+j.left+j.right).attr("height",l+j.top+j.bottom).append("g").attr("transform","translate("+j.left+","+j.top+")"),i=0;i<c.data.length;i++){var v=c.data[i];u.append("path").attr("class","series series"+c.series_style_indices[i]).attr("d",t(v))}u.append("g").attr("class","x axis").attr("transform","translate(0, "+l+")").style("font-size",c.xAxisFontSize).call(p),g=u.append("g").attr("class","y axis").style("font-size",c.yAxisFontSize).call(s),null!=c.x_axis_label&&u.append("text").attr("class","x label").attr("text-anchor","end").attr("x",k-10).attr("y",l+j.top+16).text(c.x_axis_label),null!=c.y_axis_label&&u.append("text").attr("class","y label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)").text(c.y_axis_label);var w=d3.select(c.chart_div).append("div").attr("class","line-chart-tooltip").attr("id",c.chart_div+"_tooltip").style("opacity",0);if(c.handle_clicks){var x=function(a){var b=d3.mouse(a),d=m.invert(b[0]),e=d3.bisector(c.xaccessor).left,f=e(c.data[0],d),g=c.data[0][f-1],h=c.data[0][f];return 0==f&&(g=h),f>=c.data[0].length&&(h=g),d.getTime()-c.xaccessor(g)>c.xaccessor(h)-d.getTime()?h:g};g.on("click",function(){if(c.click_callback){var a=x(this);c.click_callback(a.epoch)}});var y=g.append("g").style("display","none");y.append("line").attr("id","focusLineX").attr("class","focusLine").style("stroke-dasharray","5, 3"),y.append("line").attr("id","focusLineY").attr("class","focusLine").style("stroke-dasharray","5, 3"),y.append("circle").attr("id","focusCircle").attr("r",5).attr("class","circle focusCircle"),g.append("rect").attr("class","overlay").attr("width",k).attr("height",l).on("mouseover",function(){y.style("display",null)}).on("mouseout",function(){y.style("display","none"),w.style("opacity",0)}).on("mousemove",function(){var a=x(this),d=m(new Date(c.xaccessor(a))),e=n(c.yaccessor(a));y.style("display",null),w.style("opacity",.8),w.html(c.yaccessor(a).toFixed(4)+"<br/>"+b.toNiceDateTime(c.xaccessor(a))).style("left",d-10+"px").style("top",e+40+"px"),y.select("#focusCircle").attr("cx",d).attr("cy",e),y.select("#focusLineX").attr("x1",d).attr("y1",n(n.domain()[0])).attr("x2",d).attr("y2",n(n.domain()[1])),y.select("#focusLineY").attr("x1",m(m.domain()[0])).attr("y1",e).attr("x2",m(m.domain()[1])).attr("y2",e)})}if(c.timepoints&&c.timepoints.length>0)for(var z=0;z<c.timepoints.length;z++)for(var A=c.timepoints[z],i=0;i<A.length;i++){var B=A[i],C=B.title,D=B.epoch,E=b.toNiceDateTime(B.epoch),F=m(D);c.markerColor;!isNaN(F)&&F>0&&u.append("a").append("line").attr("id",F).attr("data:ts",E).attr("data:tt-title",C).attr("x1",F).attr("x2",F).attr("y1",0).attr("y2",c.height-j.top-j.bottom).attr("class","series"+z).style("stroke-width",c.markerStroke).style("opacity",c.markerOpacity).on("mouseover",function(a){var b=d3.select(this)[0][0].id,d=d3.select(this)[0][0].attributes[1].value,e=d3.select(this)[0][0].attributes[2].value;d3.select(this).style("opacity",1),w.style("opacity",c.markerOpacityHover),w.html(e+"<br/>"+d).style("left",b-70+"px").style("bottom",l+"px")}).on("mouseout",function(a){d3.select(this).style("opacity",c.markerOpacity),w.style("opacity",0)})}h<=0&&g.append("text").attr("x",k/2).attr("y",l/2).attr("dy","1em").attr("text-anchor","end").text("NO DATA!").attr("class","zerolinetext")},TsDashboard.prototype.drawColumnChart=function(a){var b={chart_div:"#someChart",data:null,height:400,margin_bottom:60,xaccessor:function(a){return a.name},yaccessor:function(a){return a.val},xdomain:null,xdomain_min:null,xdomain_max:null,ydomain:null,ydomain_min:null,ydomain_max:null,xcaption:null,ycaptions:null,series_style_indices:null,handle_clicks:!1,show_grid:!0,x_axis_label:null,y_axis_label:null,graph_css:"area",xAxisFontSize:"14px",yAxisFontSize:"14px",xAxisTicks:7,yFormatValue:"s",tickNumber:function(a,b){return Math.min(a<100?3:8,b)},markerStroke:3,markerOpacity:.4,markerOpacityHover:.8,markerColor:"#ff0000",click_callback:null,timepoints:null,timepoint_callback:null};if("undefined"!==a)for(var c in a)b[c]=a[c];$(b.chart_div).empty();var d={top:18,right:35,bottom:b.margin_bottom,left:50};b.x_axis_label&&(d.bottom+=20);var e=$(b.chart_div).width()-d.left-d.right,f=b.height-d.top-d.bottom,h=d3.scale.ordinal().rangeRoundBands([0,e],.1),i=d3.scale.linear().range([f,0]),j=d3.svg.axis().scale(h).orient("bottom"),k=d3.svg.axis().scale(i).orient("left"),l=d3.select(b.chart_div).append("svg").attr("width",e+d.left+d.right).attr("height",f+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")"),m=b.data;h.domain(m.map(b.xaccessor)),i.domain([0,d3.max(m,b.yaccessor)]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(j).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-45)"),l.append("g").attr("class","y axis").call(k),null!=b.x_axis_label&&l.append("text").attr("class","x label").attr("text-anchor","end").attr("x",e-10).attr("y",f+d.top+16).text(b.x_axis_label),null!=b.y_axis_label&&l.append("text").attr("class","y label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)").text(b.y_axis_label),l.selectAll(".bar").data(m).enter().append("rect").attr("class","tsd-bar").attr("x",function(a){return h(b.xaccessor(a))}).attr("y",function(a){return i(b.yaccessor(a))}).attr("height",function(a){return f-i(b.yaccessor(a))}).attr("width",h.rangeBand()).on("mouseover",function(){d3.select(this).classed("tsd-bar-highlight",!0),n.style("display",null)}).on("mouseout",function(){d3.select(this).classed("tsd-bar-highlight",!1),n.style("display","none")}).on("mousemove",function(a){var c=d3.mouse(this)[0]-15,d=d3.mouse(this)[1]-25;n.attr("transform","translate("+c+","+d+")"),n.select("text").text(b.yaccessor(a))});var n=l.append("g").attr("class","tsd-tooltip").style("display","none");n.append("rect").attr("width",30).attr("height",20),n.append("text").attr("x",15).attr("dy","1.2em").style("text-anchor","middle").attr("font-size","12px").attr("font-weight","bold"),b.handle_clicks&&l.on("click",function(){b.click_callback&&b.click_callback()}),m.length<=0&&g.append("text").attr("x",e/2).attr("y",f/2).attr("dy","1em").attr("text-anchor","end").text("NO DATA!").attr("class","zerolinetext")},Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null==this)throw new TypeError(" this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=0;d<f;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),Array.prototype.filter||(Array.prototype.filter=function(a){"use strict";if(void 0===this||null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments.length>=2?arguments[1]:void 0,f=0;f<c;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d});